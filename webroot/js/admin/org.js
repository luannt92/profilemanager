function saveHubs(e){return $(".dragndrop").children(".ibox-content").toggleClass("sk-loading"),$.ajax({method:"POST",url:appConfig.baseUrl+"admin/send-ajax",data:{id:$(".tree a.target").attr("id"),tree:e}}).done(function(e){alertMsg(JSON.parse(e)),$(".dragndrop").children(".ibox-content").toggleClass("sk-loading")}),e}function alertMsg(e){setTimeout(function(){toastr.options={closeButton:!0,preventDuplicates:!0,progressBar:!0,showMethod:"slideDown",timeOut:4e3},e.status?toastr.success(e.message,"Thông báo"):toastr.error(e.message,"Thông báo")},500)}function alertMsg(e){setTimeout(function(){toastr.options={closeButton:!0,preventDuplicates:!0,progressBar:!0,showMethod:"slideDown",timeOut:4e3},e.status?toastr.success(e.message,"Thông báo"):toastr.error(e.message,"Thông báo")},500)}function inArray(e,t){for(var r=t.length,n=0;n<r;n++)if(t[n].node==e)return!0;return!1}function getNestedChildren(e,t){var r=[];for(var n in e)if(e[n].parent==t){var a=getNestedChildren(e,e[n].id);a.length&&(e[n].children=a),r.push(e[n])}return r}var renderer=renderer||{};renderer.displayNode=function(e,t,r){if(!(r instanceof jQuery))throw"Tried to drop a hub in a place that isn't droppable, sorry.";var n=t.text()||"notext",a=r.next("ul").length;r.end();var o=$('<li><a id="node-'+t.attr("id")+'" data-level='+t.attr("data-level")+' class="node" href="#">'+n+"</a></li>");if(a)r.next("ul").append(o);else{var d=$("<ul>").append(o);r.after(d)}},renderer.dedisplayNode=function(e){if(!(e instanceof jQuery))throw"Please wrap node in jQuery before manipulation";$list=e.closest("ul"),$list.children().length<2?$list.remove():e.parent().remove()},renderer.shimmyNode=function(e,t){if(t.next("ul").length)r=t.next("ul");else{var r=$("<ul>");t.after(r)}if(r.length){var n=e.closest("li"),a=null;return 0===n.siblings("li").length&&(a=n.parent()),n.detach(),a instanceof jQuery&&a.remove(),n.appendTo(r),!0}return!1},renderer.markArticle=function(e,t){e.text("["+t.text()+"] "+e.text())};var tree={};tree.nodes="undefined"!=typeof jsTree?jsTree:[],tree.nodeId=1,tree.renderer=renderer,tree.toJson=function(){return tree.nodes},tree.pushNodeData=function(e,t){var r=e.attr("id").replace("data-node-",""),n={parent:t.attr("id"),node:r};tree.nodes.push(n)},tree.removeNodeData=function(e){for(var t=tree.nodes.length;t--;)if(tree.nodes[t].node==e.attr("id").replace("node-",""))return tree.nodes.splice(t,1),!0;return!1},tree.addNode=function(e,t){var r=tree.nodeId++,n=!1;try{this.pushNodeData(e,t),n=!0}catch(e){n=!1}return n&&tree.renderer.displayNode(r,e,t),n},tree.removeNode=function(e){if(!(e instanceof jQuery))throw"Tree hub not in correct format";return tree.renderer.dedisplayNode(e),this.removeNodeData(e)},tree.moveNode=function(e,t){var r=t.attr("id");if(!r)return!1;for(var n=tree.nodes.length;n--;)tree.nodes[n].node===e.attr("id")&&(tree.nodes[n].parent=r);tree.renderer.shimmyNode(e,t)},tree.isAcceptableMove=function(e,t){var r=e.attr("id").replace("data-node-",""),n=e.attr("data-level");return e.attr("data-level")-1!=t.attr("data-level")?(alert("Không thể drag vào level này"),!1):1==n&&inArray(r,tree.nodes)?(alert("Phần tử này đã tồn tại ở trong cây!"),!1):!(($tier=$target.parent().parent("ul"))&&($tier2=$tier.parent().parent("ul"))&&($tier3=$tier2.parent().parent("ul"))&&($tier4=$tier3.parent().parent("ul"))&&$tier4.length)||(alert("Hệ thống chỉ hỗ trợ đến cấp độ Knowledge"),!1)},tree.associateArticle=function(e,t){this.renderer.markArticle(e,t);for(var r=tree.nodes.length;r--;)if(tree.nodes[r].node===e.attr("id"))return tree.nodes[r].article=t.attr("id"),!0;return!1},$(function(){$(".hub, .article").on("dragstart",function(e){e.originalEvent.dataTransfer.setData("text",e.target.id)}),$(".tree").on("dragstart",".node",function(e){e.originalEvent.dataTransfer.setData("text",this.id)}),$(".tree").on("dragover","a",function(e){e.preventDefault()}),$("#remove").on("dragover",function(e){e.preventDefault()}),$(".tree").on("drop","a",function(e){e.preventDefault();var t=e.originalEvent.dataTransfer.getData("text");if($target=$(this),$dropped=$(document.getElementById(t)),$dropped.hasClass("article")&&!$target.hasClass("target"))return tree.associateArticle($target,$dropped);if(!tree.isAcceptableMove($dropped,$target))return!1;if(!$dropped.hasClass("hub")&&!$dropped.hasClass("node"))throw"Problem determining the type of the dropped info.";$dropped.hasClass("node")?tree.moveNode($dropped,$target):tree.addNode($dropped,$target),$dropped.hasClass("node")}),$("#remove").on("drop",function(e){e.preventDefault();var t=e.originalEvent.dataTransfer.getData("text");if($dropped=$(document.getElementById(t)),!$dropped.length)throw"Dropped element not found!";tree.removeNode($dropped)}),$("#save-hubs").on("submit, click",function(e){e.preventDefault();t=[];$(".tree li").each(function(e){var r=$(this).parent("ul").parent("li").children("a").attr("id");if(void 0!=r){var n=$(this).children("a").attr("id");n=n.replace("node-data-node-","");var a={parent:r,node:n=parseInt(n.replace("node-",""))};t.push(a)}});var t=saveHubs(t);return!1})});